## 가상 장애 대응 보고서
- 가상으로 생길 수 있는 장애 상황에 대해 시나리오를 가정해보고 대응 보고서를 작성해 본다.

### 블랙 프라이 데이 행사로 인해 사용자가 1000배 많아진 상황
- 데이터 베이스 과부하로 인해 장애 발생

`이상 징후`
- 디비 서버 CPU 사용률 95% 초과된 상태로 지속 된다.
- 쿼리 응답 시간이 1초 이상으로 증가 한다.
- 연결 타임아웃 오류가 급격히 증가 한다.

`장애 해결 타임라인`
- 즉시 조치 (30분 이내):
  - 읽기 전용 쿼리를 읽기 전용 복제본으로 리다이렉션한다
    - 주 데이터 베이스 서버의 부하를 감소 시킬 수 있다.
  - 커넥션 풀 크기를 조절 한다.
    - 동시 처리 가능한 쿼리가 증가하고, 대기 시간이 감소 한다.
  - 데이터 베이스에 부하를 주는 여러 요인들을 제거 한다.
    - 배치잡, 통계용 데이터 쿼리 수동으로 중지

- 단기 조치(6시간 이내)
  - 스케일 아웃
    - 서버 리소스를 증가 시킨다.
  - 쿼리 성능 개선
    - 조회가 오래 걸리는 쿼리에 index 처리
  - 레디스에 자주 조회되는 쿼리를 캐시처리 한다.

- 장기 조치(1주일)
  - 읽기/쓰기 분산 아키텍처를 도입 한다.
---

### Redis 다운으로 인한 장애 발생 시나리오

`가정 상황`
- Redis 서버가 다운되면서 분산 락 기능이 작동하지 않음.
- 주문 처리 API에서 동시성 제어 실패로 인해 데이터 불일치 및 재고 초과 판매 발생.
- 장애로 인해 사용자 경험이 저하되고, 주문 데이터 정합성 문제가 발생.

`이상 징후`
- 주문 중복 처리: 동일한 상품에 대해 여러 사용자가 동시에 주문 성공 처리.
- 재고 초과 판매: 상품의 재고 수량보다 많은 주문이 생성됨.
- API 응답 시간 증가: 락 재시도 로직이 실패하면서 재귀적 요청 처리로 서버 부하 발생.
- 데이터 불일치: 재고, 주문 내역, 사용자 잔액 데이터 간 불일치 상황 발생.

`장애 해결 타임라인`
- 즉시 조치 (30분 이내):
  - Redis 복구 시도
    - Redis 서버 상태 확인 및 재시작
    - 장애가 지속되면 백업된 Redis 스냅샷 복구.
  - 분산 락 기능 비활성화 및 대체 조치
    - 임시로 Redis를 사용하지 않고 DB 기반의 비관적 락으로 전환하여 동시성 문제 방지
  - 장애 알림 발송
    - 장애 발생 상황을 운영팀 및 이해관계자에게 공유

- 단기 조치 (6시간 이내):
  - 재고 데이터 정합성 검증
    - Redis 다운으로 인해 발생한 재고 초과 주문 데이터 식별.
    - 초과 주문 건에 대해 순차적으로 처리하거나 사용자에게 주문 취소 및 보상을 안내.
  - 주문 처리 부하 감소
    - 주문 API 요청을 일시적으로 제한하거나 큐를 사용해 요청을 순차 처리
  - Redis 복구 모니터링
    - Redis 서버 복구 상태를 지속적으로 점검하고, 안정성 테스트 진행.

- 장기 조치 (1주일 이내):
  - Redis 장애 대응 아키텍처 강화
    - Redis 클러스터링 설정 및 고가용성(HA) 구성
    - Redis 장애 시 fallback 전략 도입 (Redis 죽으면 DB락 자동 전환)
  - 모니터링 및 알림 시스템 강화
    - Redis의 장애 탐지 시간을 줄이기 위해 Prometheus, Grafana와 같은 실시간 모니터링 시스템 최적화
    - Redis 복구를 자동화하는 스크립트 및 운영 절차 매뉴얼 작성.

---

### 장애 인지와 복구하기 까지 시간
- MTTD (Mean Time To Detect: 평균 장애 인 시간)
  - 시스템 모니터링과 슬랙 알림을 통해 장애 발생하는 즉시 장애 인지
  - 15분 이내 관련 담당자들 에러 복구 시
- MTTR (Mean Time To Repair: 평균 복구 시간)
  - 15분 이내 오류난 서비스 복구
